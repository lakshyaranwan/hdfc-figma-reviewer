<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --hdfc-primary: #1C3FCA;
      --hdfc-dark: #08173B;
      --hdfc-medium: #0E346B;
      --hdfc-light: #E8EDFF;
      --hdfc-surface: #F5F7FF;
      --text-primary: #08173B;
      --text-secondary: #4A5568;
      --text-muted: #718096;
      --white: #FFFFFF;
      --border: #E2E8F0;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(8, 23, 59, 0.08);
      --shadow-md: 0 4px 12px rgba(8, 23, 59, 0.12);
      --shadow-lg: 0 8px 24px rgba(8, 23, 59, 0.16);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
      color: var(--text-primary);
      background: var(--hdfc-surface);
      padding: 0;
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: var(--hdfc-dark);
      color: var(--white);
      border-bottom: none;
    }
    
    .header-logo {
      width: 36px;
      height: 36px;
      background: var(--white);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }
    
    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .header-content {
      flex: 1;
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 2px;
    }
    
    .header-subtitle {
      font-size: 11px;
      opacity: 0.8;
      font-weight: 400;
    }
    
    /* Main Content */
    .main-content {
      padding: 24px;
    }
    
    /* Selection Box - Matching Component Auditor style */
    .selection-box {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--white);
      border: 2px dashed var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 24px;
    }
    
    .selection-box:hover {
      border-color: var(--hdfc-primary);
      background: rgba(28, 63, 202, 0.03);
    }
    
    .selection-box.selected {
      border-style: solid;
      border-color: var(--hdfc-primary);
      background: rgba(28, 63, 202, 0.06);
    }
    
    .selection-box .icon {
      width: 40px;
      height: 40px;
      background: var(--hdfc-light);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--hdfc-medium);
      flex-shrink: 0;
      font-size: 18px;
    }
    
    .selection-box.selected .icon {
      background: var(--hdfc-primary);
      color: white;
    }
    
    .selection-info {
      flex: 1;
      min-width: 0;
    }
    
    .selection-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }
    
    .selection-details {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .selection-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    /* Legacy selection info for detailed view */
    .selection-info-detailed {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
    }
    
    .selection-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .selection-info-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .selection-info-row:first-child {
      padding-top: 0;
    }
    
    .selection-info-label {
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
    }
    
    .selection-info-value {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 12px;
    }
    
    /* Section */
    .section {
      margin-bottom: 24px;
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--white);
      padding: 4px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    
    .tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }
    
    .tab:hover {
      background: var(--hdfc-light);
      color: var(--hdfc-primary);
    }
    
    .tab.active {
      background: var(--hdfc-primary);
      color: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Categories */
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .category-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }
    
    .category-chip:hover {
      border-color: var(--hdfc-primary);
      background: var(--hdfc-light);
    }
    
    .category-chip.selected {
      background: var(--hdfc-primary);
      border-color: var(--hdfc-primary);
      color: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    .category-chip input {
      display: none;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--hdfc-primary);
      color: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-primary:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border);
      margin-top: 12px;
    }
    
    .btn-secondary:hover {
      background: var(--hdfc-light);
      border-color: var(--hdfc-primary);
    }
    
    .btn-small {
      width: auto;
      padding: 8px 12px;
      font-size: 11px;
      border-radius: 6px;
    }
    
    .btn-apply {
      background: #ECFDF5;
      color: var(--success);
      border: 1px solid #A7F3D0;
    }
    
    .btn-apply:hover {
      background: #D1FAE5;
    }
    
    .btn-applied {
      background: var(--success);
      color: var(--white);
      border: none;
    }
    
    .btn-focus {
      background: var(--hdfc-light);
      color: var(--hdfc-primary);
      border: 1px solid var(--hdfc-primary);
    }
    
    .btn-focus:hover {
      background: var(--hdfc-primary);
      color: var(--white);
    }
    
    /* Textarea */
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      background: var(--white);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--hdfc-primary);
      box-shadow: 0 0 0 3px rgba(28, 63, 202, 0.1);
    }
    
    textarea::placeholder {
      color: var(--text-muted);
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--hdfc-primary);
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 48px 24px;
    }
    
    .loading.active {
      display: block;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--hdfc-light);
      border-top-color: var(--hdfc-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }
    
    .loading-subtext {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 6px;
    }
    
    /* Results */
    .results {
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .results-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .sort-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .sort-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .sort-btn {
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .sort-btn:hover {
      border-color: var(--hdfc-primary);
      color: var(--hdfc-primary);
    }
    
    .sort-btn.active {
      background: var(--hdfc-primary);
      color: var(--white);
      border-color: var(--hdfc-primary);
    }
    
    /* Summary Stats */
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat {
      text-align: center;
      padding: 16px 12px;
      background: var(--white);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }
    
    .stat-value.high { color: var(--error); }
    .stat-value.medium { color: var(--warning); }
    .stat-value.low { color: var(--success); }
    
    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    /* Filter Controls */
    .filter-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--white);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    
    .filter-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .filter-toggle input {
      accent-color: var(--hdfc-primary);
    }
    
    /* Category Section */
    .category-section {
      margin-bottom: 16px;
    }
    
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--white);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      cursor: pointer;
      border: 1px solid var(--border);
      border-bottom: none;
      transition: background 0.2s;
    }
    
    .category-header:hover {
      background: var(--hdfc-light);
    }
    
    .category-header.collapsed {
      border-radius: var(--radius-sm);
      border-bottom: 1px solid var(--border);
    }
    
    .category-title {
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }
    
    .category-icon {
      width: 24px;
      height: 24px;
      background: var(--hdfc-light);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .category-count {
      background: var(--hdfc-light);
      color: var(--hdfc-primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .category-content {
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      padding: 12px;
      background: var(--hdfc-surface);
    }
    
    .category-content.hidden {
      display: none;
    }
    
    /* Feedback Items */
    .feedback-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 10px;
      border-left: 4px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }
    
    .feedback-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }
    
    .feedback-item:last-child {
      margin-bottom: 0;
    }
    
    .feedback-item.high {
      border-left-color: var(--error);
      background: linear-gradient(135deg, #FEF2F2 0%, var(--white) 100%);
    }
    
    .feedback-item.medium {
      border-left-color: var(--warning);
      background: linear-gradient(135deg, #FFFBEB 0%, var(--white) 100%);
    }
    
    .feedback-item.low {
      border-left-color: var(--success);
      background: linear-gradient(135deg, #ECFDF5 0%, var(--white) 100%);
    }
    
    .feedback-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--text-primary);
      line-height: 1.4;
    }
    
    .feedback-desc {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .feedback-meta {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      font-size: 11px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .feedback-category {
      background: var(--hdfc-light);
      color: var(--hdfc-primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
      text-transform: capitalize;
    }
    
    .feedback-severity {
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    
    .feedback-severity.high {
      background: #FEE2E2;
      color: #DC2626;
    }
    
    .feedback-severity.medium {
      background: #FEF3C7;
      color: #D97706;
    }
    
    .feedback-severity.low {
      background: #D1FAE5;
      color: #059669;
    }
    
    .feedback-location {
      color: var(--text-muted);
      font-style: italic;
    }
    
    .feedback-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }
    
    /* Error */
    .error {
      background: #FEF2F2;
      border: 1px solid #FEE2E2;
      color: #DC2626;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      display: none;
      font-size: 12px;
      font-weight: 500;
    }
    
    .error.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .error-icon {
      font-size: 16px;
    }
    
    /* Scroll Area - More vertical space */
    .scroll-area {
      max-height: 520px;
      overflow-y: auto;
      padding-right: 6px;
    }
    
    .scroll-area::-webkit-scrollbar {
      width: 6px;
    }
    
    .scroll-area::-webkit-scrollbar-track {
      background: var(--hdfc-light);
      border-radius: 3px;
    }
    
    .scroll-area::-webkit-scrollbar-thumb {
      background: var(--hdfc-primary);
      border-radius: 3px;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: var(--hdfc-dark);
      color: var(--white);
      padding: 14px 18px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow-lg);
    }
    
    .toast.active {
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideUp 0.3s ease;
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.error {
      background: var(--error);
    }
    
    .toast-icon {
      font-size: 16px;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Chevron */
    .chevron {
      transition: transform 0.2s;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .chevron.collapsed {
      transform: rotate(-90deg);
    }

    /* Success message */
    .success-message {
      text-align: center;
      padding: 32px;
      background: var(--white);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    .success-icon {
      width: 64px;
      height: 64px;
      background: #D1FAE5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 32px;
    }
    
    .success-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--success);
      margin-bottom: 6px;
    }
    
    .success-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Red corners -->
        <rect x="0" y="0" width="35" height="35" fill="#ED1C24"/>
        <rect x="65" y="0" width="35" height="35" fill="#ED1C24"/>
        <rect x="0" y="65" width="35" height="35" fill="#ED1C24"/>
        <rect x="65" y="65" width="35" height="35" fill="#ED1C24"/>
        <!-- Blue center -->
        <rect x="35" y="35" width="30" height="30" fill="#004C8F"/>
      </svg>
    </div>
    <div class="header-content">
      <h1>HDFC Figma Reviewer</h1>
      <div class="header-subtitle">AI-powered design analysis</div>
    </div>
  </div>
  
  <div class="main-content">
    <div id="selectionBox"></div>
    
    <div class="error" id="error">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span id="errorText"></span>
    </div>
    
    <div id="analysisSection">
      <div class="tabs">
        <button class="tab active" data-tab="categories">Quick Review</button>
        <button class="tab" data-tab="custom">Custom Prompt</button>
      </div>
      
      <div class="tab-content active" id="categoriesTab">
        <div class="section-title">Select review categories</div>
        <div class="categories" id="categories">
          <label class="category-chip selected">
            <input type="checkbox" value="consistency" checked>
            <span>‚úì Consistency</span>
          </label>
          <label class="category-chip selected">
            <input type="checkbox" value="ux" checked>
            <span>üéØ UX Review</span>
          </label>
          <label class="category-chip selected">
            <input type="checkbox" value="ui" checked>
            <span>üé® UI Review</span>
          </label>
          <label class="category-chip">
            <input type="checkbox" value="ux_writing">
            <span>‚úçÔ∏è UX Writing</span>
          </label>
          <label class="category-chip">
            <input type="checkbox" value="high_level">
            <span>üí° High Level</span>
          </label>
        </div>
      </div>
      
      <div class="tab-content" id="customTab">
        <textarea id="customPrompt" placeholder="Enter your custom analysis prompt...&#10;&#10;Example: Focus on mobile responsiveness and button states. Check if all CTAs are clearly visible and actionable..."></textarea>
        <div class="checkbox-row">
          <input type="checkbox" id="includeSuggestions" checked>
          <label for="includeSuggestions">Include improvement suggestions</label>
        </div>
      </div>
      
      <button class="btn btn-primary" id="analyzeBtn" disabled>
        <span>Select a frame to analyze</span>
      </button>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Analyzing your design...</div>
      <div class="loading-subtext">This may take a few moments</div>
    </div>
    
    <div class="results" id="results">
      <div class="results-header">
        <div class="results-title">Analysis Results</div>
        <div class="sort-controls">
          <span class="sort-label">Sort by:</span>
          <button class="sort-btn active" data-sort="priority">Priority</button>
          <button class="sort-btn" data-sort="category">Category</button>
        </div>
      </div>
      
      <div class="summary-stats" id="summaryStats"></div>
      
      <div class="filter-controls">
        <label class="filter-toggle">
          <input type="checkbox" id="hideLowSeverity">
          <span>Hide low severity issues</span>
        </label>
      </div>
      
      <div class="scroll-area">
        <div id="feedbackList"></div>
      </div>
      
      <button class="btn btn-primary" id="newAnalysisBtn" style="margin-top: 16px;">
        <span>üîÑ</span>
        <span>Analyze Again</span>
      </button>
    </div>
  </div>
  
  <div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon">‚úì</span>
    <span id="toastText"></span>
  </div>
  
  <script>
    // Backend URL
    const SUPABASE_URL = 'https://lvhtpmtmxxfeomyqvnuq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHRwbXRteHhmZW9teXF2bnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ5NjIsImV4cCI6MjA3ODY4MDk2Mn0.ZeCg-6BKIySftZ8DV3V0uz4LK_FoA0ngSG2OIJpoCUc';
    
    let selectionData = null;
    let analysisResults = [];
    let currentSort = 'priority';
    let appliedItems = new Set();
    let collapsedCategories = new Set();
    
    // Category config
    const categoryConfig = {
      consistency: { label: 'Consistency', icon: '‚úì' },
      ux: { label: 'UX Review', icon: 'üéØ' },
      ui: { label: 'UI Review', icon: 'üé®' },
      ux_writing: { label: 'UX Writing', icon: '‚úçÔ∏è' },
      high_level: { label: 'High Level', icon: 'üí°' },
      improvement: { label: 'Improvement', icon: '‚ú®' }
    };
    
    const categoryOrder = ['consistency', 'ux', 'ui', 'ux_writing', 'high_level', 'improvement'];
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });
    
    // Category chip selection
    document.querySelectorAll('.category-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const checkbox = chip.querySelector('input');
        checkbox.checked = !checkbox.checked;
        chip.classList.toggle('selected', checkbox.checked);
      });
    });
    
    // Sort controls
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        displayResults();
      });
    });
    
    // Filter controls
    document.getElementById('hideLowSeverity').addEventListener('change', displayResults);
    
    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'selection-data') {
        selectionData = msg.data;
        updateSelectionUI();
      }
      
      if (msg.type === 'analyze-data') {
        runAnalysis(msg.data);
      }
      
      if (msg.type === 'apply-complete') {
        if (msg.success) {
          appliedItems.add(msg.itemId);
          const changesText = msg.appliedChanges && msg.appliedChanges.length > 0 
            ? `Applied: ${msg.appliedChanges.join(', ')}` 
            : 'Suggestion applied!';
          showToast(changesText, 'success');
          displayResults();
        } else {
          showToast('Failed to apply: ' + msg.error, 'error');
        }
      }
    };
    
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      const toastText = document.getElementById('toastText');
      const toastIcon = document.getElementById('toastIcon');
      
      toastText.textContent = message;
      toastIcon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
      toast.className = 'toast active ' + type;
      
      setTimeout(() => toast.classList.remove('active'), 3500);
    }
    
    function updateSelectionUI() {
      const box = document.getElementById('selectionBox');
      const btn = document.getElementById('analyzeBtn');
      
      if (!selectionData || !selectionData.hasSelection) {
        box.innerHTML = `
          <div class="selection-box" onclick="requestSelection()">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
                <line x1="15" y1="3" x2="15" y2="21"></line>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="3" y1="15" x2="21" y2="15"></line>
              </svg>
            </div>
            <div class="selection-info">
              <div class="selection-name">Click to select a frame</div>
              <div class="selection-hint">Select a frame, section, or component</div>
            </div>
          </div>
        `;
        btn.disabled = true;
        btn.innerHTML = '<span>Select a frame to analyze</span>';
      } else {
        const nodeNames = selectionData.nodes.map(n => n.name).slice(0, 2).join(', ');
        const moreCount = selectionData.nodes.length > 2 ? ` +${selectionData.nodes.length - 2} more` : '';
        const nodeCount = selectionData.nodes.length;
        const details = `${selectionData.pageName || 'Page'} ‚Ä¢ ${nodeCount} item${nodeCount > 1 ? 's' : ''} selected`;
        
        box.innerHTML = `
          <div class="selection-box selected" onclick="requestSelection()">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <div class="selection-info">
              <div class="selection-name">${nodeNames}${moreCount}</div>
              <div class="selection-details">${details}</div>
            </div>
          </div>
        `;
        btn.disabled = false;
        btn.innerHTML = '<span>‚ú®</span><span>Analyze Design</span>';
      }
    }
    
    function requestSelection() {
      // Request the current selection from Figma
      parent.postMessage({ pluginMessage: { type: 'get-selection' } }, '*');
    }
    
    function showError(message) {
      const errorEl = document.getElementById('error');
      document.getElementById('errorText').textContent = message;
      errorEl.classList.add('active');
    }
    
    function hideError() {
      document.getElementById('error').classList.remove('active');
    }
    
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
      document.getElementById('analysisSection').style.display = show ? 'none' : 'block';
      document.getElementById('results').classList.remove('active');
    }
    
    function buildPrompt() {
      const customTab = document.getElementById('customTab').classList.contains('active');
      
      if (customTab) {
        let prompt = document.getElementById('customPrompt').value.trim();
        if (!prompt) return null;
        if (document.getElementById('includeSuggestions').checked) {
          prompt += '\n\nFor each issue, provide specific actionable suggestions on how to fix it.';
        }
        return { prompt, categories: null, isCustom: true };
      }
      
      const selectedCategories = [];
      document.querySelectorAll('.category-chip input:checked').forEach(cb => {
        selectedCategories.push(cb.value);
      });
      
      if (selectedCategories.length === 0) {
        return null;
      }
      
      const categoryLabels = {
        consistency: 'Consistency across flows regarding UI',
        ux: 'UX Review',
        ui: 'UI Review',
        accessibility: 'Accessibility Issues',
        design_system: 'Design System Adherence',
        ux_writing: 'Typos & Inconsistent UX Writing',
        high_level: 'High Level Review About and the Why? Questioning the basics.'
      };
      
      const categoryDescriptions = selectedCategories.map(c => categoryLabels[c]).join(', ');
      const prompt = `I am a UI UX designer who lacks attention to detail and makes a lot of mistakes. Act as my manager and reviewer. Provide me feedback on the following areas: ${categoryDescriptions}. For each issue, provide specific actionable suggestions on how to fix it.`;
      
      return { prompt, categories: selectedCategories, isCustom: false };
    }
    
    async function analyze() {
      hideError();
      
      if (!selectionData || !selectionData.hasSelection) {
        showError('Please select a frame or component first');
        return;
      }
      
      const promptData = buildPrompt();
      if (!promptData) {
        showError('Please select at least one category or enter a custom prompt');
        return;
      }
      
      parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
    }
    
    async function runAnalysis(data) {
      const promptData = buildPrompt();
      if (!promptData) return;
      
      showLoading(true);
      appliedItems.clear();
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-plugin`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            designData: data.nodes,
            prompt: promptData.prompt,
            categories: promptData.categories,
            isCustom: promptData.isCustom,
            fileName: data.fileName,
            pageName: data.pageName
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Analysis failed (${response.status})`);
        }
        
        const result = await response.json();
        analysisResults = result.feedback || [];
        displayResults();
        
        parent.postMessage({ pluginMessage: { type: 'analysis-complete' } }, '*');
        
      } catch (error) {
        showError(error.message || 'Analysis failed. Please try again.');
        showLoading(false);
        document.getElementById('analysisSection').style.display = 'block';
      }
    }
    
    function displayResults() {
      showLoading(false);
      
      const resultsEl = document.getElementById('results');
      const feedbackList = document.getElementById('feedbackList');
      const summaryStats = document.getElementById('summaryStats');
      const analysisSection = document.getElementById('analysisSection');
      const hideLow = document.getElementById('hideLowSeverity').checked;
      
      analysisSection.style.display = 'none';
      
      // Filter
      let filteredResults = hideLow 
        ? analysisResults.filter(f => f.severity !== 'low')
        : [...analysisResults];
      
      if (filteredResults.length === 0 && analysisResults.length === 0) {
        feedbackList.innerHTML = `
          <div class="success-message">
            <div class="success-icon">‚úì</div>
            <div class="success-title">No issues found!</div>
            <div class="success-subtitle">Your design looks great. Keep up the excellent work.</div>
          </div>
        `;
        summaryStats.innerHTML = '';
        resultsEl.classList.add('active');
        return;
      }
      
      // Summary stats
      const highCount = analysisResults.filter(f => f.severity === 'high').length;
      const mediumCount = analysisResults.filter(f => f.severity === 'medium').length;
      const lowCount = analysisResults.filter(f => f.severity === 'low').length;
      
      summaryStats.innerHTML = `
        <div class="stat">
          <div class="stat-value high">${highCount}</div>
          <div class="stat-label">High</div>
        </div>
        <div class="stat">
          <div class="stat-value medium">${mediumCount}</div>
          <div class="stat-label">Medium</div>
        </div>
        <div class="stat">
          <div class="stat-value low">${lowCount}</div>
          <div class="stat-label">Low</div>
        </div>
        <div class="stat">
          <div class="stat-value">${filteredResults.length}</div>
          <div class="stat-label">Showing</div>
        </div>
      `;
      
      if (currentSort === 'priority') {
        // Sort by severity
        filteredResults.sort((a, b) => {
          const aSev = a.severity ? a.severity.toLowerCase() : 'low';
          const bSev = b.severity ? b.severity.toLowerCase() : 'low';
          const aOrder = aSev === 'high' ? 0 : (aSev === 'medium' ? 1 : 2);
          const bOrder = bSev === 'high' ? 0 : (bSev === 'medium' ? 1 : 2);
          return aOrder - bOrder;
        });
        
        feedbackList.innerHTML = filteredResults.map(item => renderFeedbackItem(item)).join('');
      } else {
        // Group by category
        const grouped = {};
        filteredResults.forEach(item => {
          const cat = item.category || 'general';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(item);
        });
        
        let html = '';
        categoryOrder.forEach(cat => {
          if (grouped[cat] && grouped[cat].length > 0) {
            const config = categoryConfig[cat] || { label: cat, icon: 'üìã' };
            const isCollapsed = collapsedCategories.has(cat);
            html += `
              <div class="category-section">
                <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${cat}')">
                  <span class="category-title">
                    <span class="category-icon">${config.icon}</span>
                    <span>${config.label}</span>
                  </span>
                  <span class="category-count">${grouped[cat].length}</span>
                </div>
                <div class="category-content ${isCollapsed ? 'hidden' : ''}">
                  ${grouped[cat].map(item => renderFeedbackItem(item)).join('')}
                </div>
              </div>
            `;
          }
        });
        
        // Handle unknown categories
        Object.keys(grouped).forEach(cat => {
          if (!categoryOrder.includes(cat)) {
            const isCollapsed = collapsedCategories.has(cat);
            html += `
              <div class="category-section">
                <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${cat}')">
                  <span class="category-title">
                    <span class="category-icon">üìã</span>
                    <span>${cat}</span>
                  </span>
                  <span class="category-count">${grouped[cat].length}</span>
                </div>
                <div class="category-content ${isCollapsed ? 'hidden' : ''}">
                  ${grouped[cat].map(item => renderFeedbackItem(item)).join('')}
                </div>
              </div>
            `;
          }
        });
        
        feedbackList.innerHTML = html;
      }
      
      resultsEl.classList.add('active');
    }
    
    function toggleCategory(cat) {
      if (collapsedCategories.has(cat)) {
        collapsedCategories.delete(cat);
      } else {
        collapsedCategories.add(cat);
      }
      displayResults();
    }
    
    function renderFeedbackItem(item) {
      const severity = (item.severity || 'low').toLowerCase();
      const isApplied = appliedItems.has(item.id || item.title);
      const itemId = item.id || item.title;
      
      return `
        <div class="feedback-item ${severity}" onclick="focusNode('${item.nodeId || ''}', '${(item.location || '').replace(/'/g, "\\'")}')">
          <div class="feedback-title">${item.title || 'Issue'}</div>
          <div class="feedback-desc">${item.description || ''}</div>
          <div class="feedback-meta">
            <span class="feedback-severity ${severity}">${severity}</span>
            ${item.location ? `<span class="feedback-location">üìç ${item.location}</span>` : ''}
          </div>
          <div class="feedback-actions">
            <button class="btn btn-small btn-focus" onclick="event.stopPropagation(); focusNode('${item.nodeId || ''}', '${(item.location || '').replace(/'/g, "\\'")}')">
              üîç Focus
            </button>
            ${item.suggestion ? `
              <button class="btn btn-small ${isApplied ? 'btn-applied' : 'btn-apply'}" 
                onclick="event.stopPropagation(); applySuggestion('${itemId.replace(/'/g, "\\'")}', '${item.nodeId || ''}', '${(item.location || '').replace(/'/g, "\\'")}', '${(item.suggestion || item.description || '').replace(/'/g, "\\'")}', '${(item.title || '').replace(/'/g, "\\'")}')"
                ${isApplied ? 'disabled' : ''}>
                ${isApplied ? '‚úì Applied' : '‚ö° Apply'}
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function focusNode(nodeId, location) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'focus-node', 
          nodeId: nodeId,
          location: location
        } 
      }, '*');
    }
    
    function applySuggestion(itemId, nodeId, location, suggestion, title) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'apply-suggestion',
          itemId: itemId,
          nodeId: nodeId,
          location: location,
          suggestion: suggestion,
          title: title
        } 
      }, '*');
    }
    
    // Button events
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('newAnalysisBtn').addEventListener('click', () => {
      document.getElementById('results').classList.remove('active');
      document.getElementById('analysisSection').style.display = 'block';
      analysisResults = [];
    });
    
    // Initial UI
    updateSelectionUI();
  </script>
</body>
</html>