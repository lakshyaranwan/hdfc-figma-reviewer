<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      background: #fff;
      padding: 16px;
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .selection-info {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border: 1px solid #e0e7ff;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 16px;
    }
    
    .selection-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .selection-info-row:last-child {
      margin-bottom: 0;
    }
    
    .selection-info-label {
      color: #666;
      font-size: 11px;
    }
    
    .selection-info-value {
      font-weight: 500;
      color: #333;
      font-size: 11px;
    }
    
    .no-selection {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .no-selection-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .no-selection-text {
      color: #9a3412;
      font-size: 12px;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .category-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: #f0f0f0;
      border: 1px solid transparent;
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .category-chip:hover {
      background: #e5e5e5;
    }
    
    .category-chip.selected {
      background: #e8f4ff;
      border-color: #0d99ff;
      color: #0d99ff;
    }
    
    .category-chip input {
      display: none;
    }
    
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0d99ff 0%, #0066cc 100%);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 153, 255, 0.3);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 8px;
    }
    
    .btn-secondary:hover {
      background: #e5e5e5;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .loading.active {
      display: block;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e5e5;
      border-top-color: #0d99ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 12px;
    }
    
    .results {
      display: none;
      margin-top: 16px;
    }
    
    .results.active {
      display: block;
    }
    
    .feedback-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 3px solid #ddd;
    }
    
    .feedback-item.high {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .feedback-item.medium {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    
    .feedback-item.low {
      border-left-color: #22c55e;
      background: #f0fdf4;
    }
    
    .feedback-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
      color: #1a1a1a;
    }
    
    .feedback-desc {
      font-size: 11px;
      color: #555;
      line-height: 1.5;
    }
    
    .feedback-meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      font-size: 10px;
    }
    
    .feedback-category {
      background: #e5e5e5;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: capitalize;
    }
    
    .feedback-severity {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: capitalize;
    }
    
    .feedback-severity.high {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .feedback-severity.medium {
      background: #fef3c7;
      color: #d97706;
    }
    
    .feedback-severity.low {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fee2e2;
      color: #dc2626;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: none;
      font-size: 11px;
    }
    
    .error.active {
      display: block;
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .tab {
      flex: 1;
      padding: 8px;
      border: none;
      background: #f0f0f0;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab.active {
      background: #0d99ff;
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    textarea:focus {
      outline: none;
      border-color: #0d99ff;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
    }
    
    .summary-stats {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .stat {
      flex: 1;
      text-align: center;
      padding: 10px 8px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 600;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }
    
    .scroll-area {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0d99ff" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 16v-4M12 8h.01"/>
    </svg>
    <h1>Design Analyzer</h1>
  </div>
  
  <div id="selectionBox"></div>
  
  <div class="error" id="error"></div>
  
  <div id="analysisSection">
    <div class="tabs">
      <button class="tab active" data-tab="categories">Categories</button>
      <button class="tab" data-tab="custom">Custom Prompt</button>
    </div>
    
    <div class="tab-content active" id="categoriesTab">
      <div class="categories" id="categories">
        <label class="category-chip selected">
          <input type="checkbox" value="consistency" checked>
          <span>Consistency</span>
        </label>
        <label class="category-chip selected">
          <input type="checkbox" value="ux" checked>
          <span>UX</span>
        </label>
        <label class="category-chip selected">
          <input type="checkbox" value="accessibility" checked>
          <span>Accessibility</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="ui">
          <span>UI</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="typography">
          <span>Typography</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="ux_writing">
          <span>UX Writing</span>
        </label>
      </div>
    </div>
    
    <div class="tab-content" id="customTab">
      <textarea id="customPrompt" placeholder="Enter your custom analysis prompt...&#10;&#10;Example: Check if buttons have consistent styles and proper touch targets"></textarea>
      <div class="checkbox-row">
        <input type="checkbox" id="includeSuggestions" checked>
        <label for="includeSuggestions">Include improvement suggestions</label>
      </div>
    </div>
    
    <button class="btn btn-primary" id="analyzeBtn" disabled>Select a frame to analyze</button>
  </div>
  
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing your design with AI...</div>
  </div>
  
  <div class="results" id="results">
    <div class="section-title">Analysis Results</div>
    <div class="summary-stats" id="summaryStats"></div>
    <div class="scroll-area">
      <div id="feedbackList"></div>
    </div>
    <button class="btn btn-primary" id="newAnalysisBtn" style="margin-top: 12px;">Analyze Again</button>
  </div>
  
  <script>
    // Backend URL - uses your Supabase project
    const SUPABASE_URL = 'https://lvhtpmtmxxfeomyqvnuq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHRwbXRteHhmZW9teXF2bnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ5NjIsImV4cCI6MjA3ODY4MDk2Mn0.ZeCg-6BKIySftZ8DV3V0uz4LK_FoA0ngSG2OIJpoCUc';
    
    let selectionData = null;
    let analysisResults = [];
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });
    
    // Category chip selection
    document.querySelectorAll('.category-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const checkbox = chip.querySelector('input');
        checkbox.checked = !checkbox.checked;
        chip.classList.toggle('selected', checkbox.checked);
      });
    });
    
    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'selection-data') {
        selectionData = msg.data;
        updateSelectionUI();
      }
      
      if (msg.type === 'analyze-data') {
        // This is triggered when we request analysis
        runAnalysis(msg.data);
      }
    };
    
    function updateSelectionUI() {
      const box = document.getElementById('selectionBox');
      const btn = document.getElementById('analyzeBtn');
      
      if (!selectionData || !selectionData.hasSelection) {
        box.innerHTML = `
          <div class="no-selection">
            <div class="no-selection-icon">ðŸ‘†</div>
            <div class="no-selection-text">Select a frame or component to analyze</div>
          </div>
        `;
        btn.disabled = true;
        btn.textContent = 'Select a frame to analyze';
      } else {
        const nodeNames = selectionData.nodes.map(n => n.name).slice(0, 3).join(', ');
        const moreCount = selectionData.nodes.length > 3 ? ` +${selectionData.nodes.length - 3} more` : '';
        
        box.innerHTML = `
          <div class="selection-info">
            <div class="selection-info-row">
              <span class="selection-info-label">File</span>
              <span class="selection-info-value">${selectionData.fileName || '-'}</span>
            </div>
            <div class="selection-info-row">
              <span class="selection-info-label">Page</span>
              <span class="selection-info-value">${selectionData.pageName || '-'}</span>
            </div>
            <div class="selection-info-row">
              <span class="selection-info-label">Selected</span>
              <span class="selection-info-value">${nodeNames}${moreCount}</span>
            </div>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'âœ¨ Analyze Design';
      }
    }
    
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.classList.add('active');
    }
    
    function hideError() {
      document.getElementById('error').classList.remove('active');
    }
    
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
      document.getElementById('analysisSection').style.display = show ? 'none' : 'block';
      document.getElementById('results').classList.remove('active');
    }
    
    function buildPrompt() {
      const customTab = document.getElementById('customTab').classList.contains('active');
      
      if (customTab) {
        let prompt = document.getElementById('customPrompt').value.trim();
        if (!prompt) return null;
        if (document.getElementById('includeSuggestions').checked) {
          prompt += '\n\nPlease include specific improvement suggestions for each issue found.';
        }
        return prompt;
      }
      
      const selectedCategories = [];
      document.querySelectorAll('.category-chip input:checked').forEach(cb => {
        selectedCategories.push(cb.value);
      });
      
      if (selectedCategories.length === 0) {
        return null;
      }
      
      const categoryLabels = {
        consistency: 'Design consistency (colors, spacing, fonts)',
        ux: 'User experience and usability',
        accessibility: 'Accessibility (contrast, touch targets, labels)',
        ui: 'Visual design and aesthetics',
        typography: 'Typography and readability',
        ux_writing: 'UX writing and microcopy'
      };
      
      const categoryDescriptions = selectedCategories.map(c => categoryLabels[c]).join(', ');
      
      return `Analyze this design for the following aspects: ${categoryDescriptions}. 
              For each issue found, provide:
              1. A clear title
              2. A detailed description of the problem
              3. The severity (low, medium, high)
              4. The category
              5. Specific location in the design if identifiable
              6. A concrete suggestion for improvement`;
    }
    
    async function analyze() {
      hideError();
      
      if (!selectionData || !selectionData.hasSelection) {
        showError('Please select a frame or component first');
        return;
      }
      
      const prompt = buildPrompt();
      if (!prompt) {
        showError('Please select at least one category or enter a custom prompt');
        return;
      }
      
      // Request the latest selection data and trigger analysis
      parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
    }
    
    async function runAnalysis(data) {
      const prompt = buildPrompt();
      if (!prompt) return;
      
      showLoading(true);
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-plugin`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            designData: data.nodes,
            prompt: prompt,
            fileName: data.fileName,
            pageName: data.pageName
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Analysis failed (${response.status})`);
        }
        
        const result = await response.json();
        analysisResults = result.feedback || [];
        displayResults();
        
        parent.postMessage({ pluginMessage: { type: 'analysis-complete' } }, '*');
        
      } catch (error) {
        showError(error.message || 'Analysis failed. Please try again.');
        showLoading(false);
        document.getElementById('analysisSection').style.display = 'block';
      }
    }
    
    function displayResults() {
      showLoading(false);
      
      const resultsEl = document.getElementById('results');
      const feedbackList = document.getElementById('feedbackList');
      const summaryStats = document.getElementById('summaryStats');
      const analysisSection = document.getElementById('analysisSection');
      
      analysisSection.style.display = 'none';
      
      if (analysisResults.length === 0) {
        feedbackList.innerHTML = '<div style="text-align: center; color: #22c55e; padding: 20px;">âœ… No issues found! Your design looks great.</div>';
        summaryStats.innerHTML = '';
        resultsEl.classList.add('active');
        return;
      }
      
      // Summary stats
      const highCount = analysisResults.filter(f => f.severity === 'high').length;
      const mediumCount = analysisResults.filter(f => f.severity === 'medium').length;
      const lowCount = analysisResults.filter(f => f.severity === 'low').length;
      
      summaryStats.innerHTML = `
        <div class="stat">
          <div class="stat-value" style="color: #dc2626">${highCount}</div>
          <div class="stat-label">High</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #d97706">${mediumCount}</div>
          <div class="stat-label">Medium</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #16a34a">${lowCount}</div>
          <div class="stat-label">Low</div>
        </div>
      `;
      
      // Sort by severity
      const severityOrder = { high: 0, medium: 1, low: 2 };
      const sortedResults = [...analysisResults].sort((a, b) => 
        (severityOrder[a.severity] || 2) - (severityOrder[b.severity] || 2)
      );
      
      // Feedback items
      feedbackList.innerHTML = sortedResults.map(item => `
        <div class="feedback-item ${item.severity || 'low'}">
          <div class="feedback-title">${item.title}</div>
          <div class="feedback-desc">${item.description}</div>
          <div class="feedback-meta">
            <span class="feedback-category">${item.category || 'general'}</span>
            <span class="feedback-severity ${item.severity || 'low'}">${item.severity || 'low'}</span>
            ${item.location ? `<span style="color: #888">${item.location}</span>` : ''}
          </div>
        </div>
      `).join('');
      
      resultsEl.classList.add('active');
    }
    
    function resetToAnalysis() {
      document.getElementById('results').classList.remove('active');
      document.getElementById('analysisSection').style.display = 'block';
      analysisResults = [];
    }
    
    // Event listeners
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('newAnalysisBtn').addEventListener('click', resetToAnalysis);
  </script>
</body>
</html>
