<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      background: #fff;
      padding: 16px;
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .selection-info {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border: 1px solid #e0e7ff;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 16px;
    }
    
    .selection-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .selection-info-row:last-child {
      margin-bottom: 0;
    }
    
    .selection-info-label {
      color: #666;
      font-size: 11px;
    }
    
    .selection-info-value {
      font-weight: 500;
      color: #333;
      font-size: 11px;
    }
    
    .no-selection {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .no-selection-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .no-selection-text {
      color: #9a3412;
      font-size: 12px;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .category-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: #f0f0f0;
      border: 1px solid transparent;
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .category-chip:hover {
      background: #e5e5e5;
    }
    
    .category-chip.selected {
      background: #e8f4ff;
      border-color: #0d99ff;
      color: #0d99ff;
    }
    
    .category-chip input {
      display: none;
    }
    
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0d99ff 0%, #0066cc 100%);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 153, 255, 0.3);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 8px;
    }
    
    .btn-secondary:hover {
      background: #e5e5e5;
    }
    
    .btn-small {
      width: auto;
      padding: 6px 10px;
      font-size: 10px;
      border-radius: 4px;
    }
    
    .btn-comment {
      background: #f0f4ff;
      color: #0066cc;
      border: 1px solid #cce0ff;
    }
    
    .btn-comment:hover {
      background: #e0ebff;
    }
    
    .btn-apply {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }
    
    .btn-apply:hover {
      background: #dcfce7;
    }
    
    .btn-applied {
      background: #22c55e;
      color: white;
      border: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .loading.active {
      display: block;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e5e5;
      border-top-color: #0d99ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 12px;
    }
    
    .results {
      display: none;
      margin-top: 16px;
    }
    
    .results.active {
      display: block;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .sort-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .sort-btn {
      padding: 4px 8px;
      font-size: 10px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .sort-btn.active {
      background: #0d99ff;
      color: white;
      border-color: #0d99ff;
    }
    
    .filter-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    
    .filter-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .category-section {
      margin-bottom: 16px;
    }
    
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #f5f5f5;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      border: 1px solid #e5e5e5;
      border-bottom: none;
    }
    
    .category-header:hover {
      background: #eee;
    }
    
    .category-header.collapsed {
      border-radius: 8px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .category-title {
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .category-count {
      background: #e5e5e5;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .category-content {
      border: 1px solid #e5e5e5;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 8px;
    }
    
    .category-content.hidden {
      display: none;
    }
    
    .feedback-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 3px solid #ddd;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.1s;
    }
    
    .feedback-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateX(2px);
    }
    
    .feedback-item:last-child {
      margin-bottom: 0;
    }
    
    .feedback-item.high {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .feedback-item.medium {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    
    .feedback-item.low {
      border-left-color: #22c55e;
      background: #f0fdf4;
    }
    
    .feedback-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
      color: #1a1a1a;
    }
    
    .feedback-desc {
      font-size: 11px;
      color: #555;
      line-height: 1.5;
    }
    
    .feedback-meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      font-size: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .feedback-category {
      background: #e5e5e5;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: capitalize;
    }
    
    .feedback-severity {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: capitalize;
    }
    
    .feedback-severity.high {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .feedback-severity.medium {
      background: #fef3c7;
      color: #d97706;
    }
    
    .feedback-severity.low {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .feedback-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fee2e2;
      color: #dc2626;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: none;
      font-size: 11px;
    }
    
    .error.active {
      display: block;
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .tab {
      flex: 1;
      padding: 8px;
      border: none;
      background: #f0f0f0;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab.active {
      background: #0d99ff;
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    textarea:focus {
      outline: none;
      border-color: #0d99ff;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
    }
    
    .summary-stats {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .stat {
      flex: 1;
      text-align: center;
      padding: 10px 8px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 600;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }
    
    .scroll-area {
      max-height: 350px;
      overflow-y: auto;
    }
    
    .toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    
    .toast.active {
      display: block;
      animation: slideUp 0.3s ease;
    }
    
    .toast.success {
      background: #16a34a;
    }
    
    .toast.error {
      background: #dc2626;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .chevron {
      transition: transform 0.2s;
    }
    
    .chevron.collapsed {
      transform: rotate(-90deg);
    }
  </style>
</head>
<body>
  <div class="header">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0d99ff" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 16v-4M12 8h.01"/>
    </svg>
    <h1>Design Analyzer</h1>
  </div>
  
  <div id="selectionBox"></div>
  
  <div class="error" id="error"></div>
  
  <div id="analysisSection">
    <div class="tabs">
      <button class="tab active" data-tab="categories">Simple</button>
      <button class="tab" data-tab="custom">Manual</button>
    </div>
    
    <div class="tab-content active" id="categoriesTab">
      <div class="section-title">Choose what to review:</div>
      <div class="categories" id="categories">
        <label class="category-chip selected">
          <input type="checkbox" value="consistency" checked>
          <span>Consistency across flows</span>
        </label>
        <label class="category-chip selected">
          <input type="checkbox" value="ux" checked>
          <span>UX Review</span>
        </label>
        <label class="category-chip selected">
          <input type="checkbox" value="ui" checked>
          <span>UI Review</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="accessibility">
          <span>Accessibility</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="design_system">
          <span>Design System</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="ux_writing">
          <span>UX Writing</span>
        </label>
        <label class="category-chip">
          <input type="checkbox" value="high_level">
          <span>High Level Review</span>
        </label>
      </div>
    </div>
    
    <div class="tab-content" id="customTab">
      <textarea id="customPrompt" placeholder="Enter your custom analysis prompt...&#10;&#10;Example: Focus on mobile responsiveness and button states. Check if all CTAs are clearly visible..."></textarea>
      <div class="checkbox-row">
        <input type="checkbox" id="includeSuggestions" checked>
        <label for="includeSuggestions">Include improvement suggestions</label>
      </div>
    </div>
    
    <button class="btn btn-primary" id="analyzeBtn" disabled>Select a frame to analyze</button>
  </div>
  
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing your design with AI...</div>
  </div>
  
  <div class="results" id="results">
    <div class="results-header">
      <div class="section-title">Analysis Results</div>
      <div class="sort-controls">
        <span style="font-size: 10px; color: #666;">Sort:</span>
        <button class="sort-btn active" data-sort="priority">Priority</button>
        <button class="sort-btn" data-sort="category">Category</button>
      </div>
    </div>
    
    <div class="summary-stats" id="summaryStats"></div>
    
    <div class="filter-controls">
      <label class="filter-toggle">
        <input type="checkbox" id="hideLowSeverity">
        <span>Hide low severity</span>
      </label>
    </div>
    
    <div class="scroll-area">
      <div id="feedbackList"></div>
    </div>
    <button class="btn btn-primary" id="newAnalysisBtn" style="margin-top: 12px;">Analyze Again</button>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // Backend URL - uses your Supabase project
    const SUPABASE_URL = 'https://lvhtpmtmxxfeomyqvnuq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHRwbXRteHhmZW9teXF2bnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ5NjIsImV4cCI6MjA3ODY4MDk2Mn0.ZeCg-6BKIySftZ8DV3V0uz4LK_FoA0ngSG2OIJpoCUc';
    
    let selectionData = null;
    let analysisResults = [];
    let currentSort = 'priority';
    let appliedItems = new Set();
    let commentedItems = new Set();
    let collapsedCategories = new Set();
    
    // Category config matching webapp
    const categoryConfig = {
      consistency: { label: 'Consistency across flows regarding UI', icon: '‚úì' },
      ux: { label: 'UX Review', icon: 'üéØ' },
      ui: { label: 'UI Review', icon: '‚ö†' },
      accessibility: { label: 'Accessibility Issues', icon: '‚ôø' },
      design_system: { label: 'Design System Adherence', icon: 'üìê' },
      ux_writing: { label: 'Typos & Inconsistent UX Writing', icon: '‚úç' },
      high_level: { label: 'High Level Review', icon: 'üí°' },
      improvement: { label: 'Improvement', icon: '‚ú®' }
    };
    
    const categoryOrder = ['consistency', 'ux', 'ui', 'accessibility', 'design_system', 'ux_writing', 'high_level', 'improvement'];
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });
    
    // Category chip selection
    document.querySelectorAll('.category-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const checkbox = chip.querySelector('input');
        checkbox.checked = !checkbox.checked;
        chip.classList.toggle('selected', checkbox.checked);
      });
    });
    
    // Sort controls
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        displayResults();
      });
    });
    
    // Filter controls
    document.getElementById('hideLowSeverity').addEventListener('change', displayResults);
    
    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'selection-data') {
        selectionData = msg.data;
        updateSelectionUI();
      }
      
      if (msg.type === 'analyze-data') {
        runAnalysis(msg.data);
      }
      
      if (msg.type === 'comment-posted') {
        if (msg.success) {
          commentedItems.add(msg.itemId);
          showToast('Comment added to Figma!', 'success');
          displayResults();
        } else {
          showToast('Failed to add comment: ' + msg.error, 'error');
        }
      }
      
      if (msg.type === 'apply-complete') {
        if (msg.success) {
          appliedItems.add(msg.itemId);
          const changesText = msg.appliedChanges && msg.appliedChanges.length > 0 
            ? `Applied: ${msg.appliedChanges.join(', ')}` 
            : 'Suggestion applied!';
          showToast(changesText, 'success');
          displayResults();
        } else {
          showToast('Failed to apply: ' + msg.error, 'error');
        }
      }
    };
    
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast active ' + type;
      setTimeout(() => toast.classList.remove('active'), 3000);
    }
    
    function updateSelectionUI() {
      const box = document.getElementById('selectionBox');
      const btn = document.getElementById('analyzeBtn');
      
      if (!selectionData || !selectionData.hasSelection) {
        box.innerHTML = `
          <div class="no-selection">
            <div class="no-selection-icon">üëÜ</div>
            <div class="no-selection-text">Select a frame or component to analyze</div>
          </div>
        `;
        btn.disabled = true;
        btn.textContent = 'Select a frame to analyze';
      } else {
        const nodeNames = selectionData.nodes.map(n => n.name).slice(0, 3).join(', ');
        const moreCount = selectionData.nodes.length > 3 ? ` +${selectionData.nodes.length - 3} more` : '';
        
        box.innerHTML = `
          <div class="selection-info">
            <div class="selection-info-row">
              <span class="selection-info-label">File</span>
              <span class="selection-info-value">${selectionData.fileName || '-'}</span>
            </div>
            <div class="selection-info-row">
              <span class="selection-info-label">Page</span>
              <span class="selection-info-value">${selectionData.pageName || '-'}</span>
            </div>
            <div class="selection-info-row">
              <span class="selection-info-label">Selected</span>
              <span class="selection-info-value">${nodeNames}${moreCount}</span>
            </div>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = '‚ú® Analyze Design';
      }
    }
    
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.classList.add('active');
    }
    
    function hideError() {
      document.getElementById('error').classList.remove('active');
    }
    
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
      document.getElementById('analysisSection').style.display = show ? 'none' : 'block';
      document.getElementById('results').classList.remove('active');
    }
    
    function buildPrompt() {
      const customTab = document.getElementById('customTab').classList.contains('active');
      
      if (customTab) {
        let prompt = document.getElementById('customPrompt').value.trim();
        if (!prompt) return null;
        if (document.getElementById('includeSuggestions').checked) {
          prompt += '\n\nFor each issue, provide specific actionable suggestions on how to fix it.';
        }
        return { prompt, categories: null, isCustom: true };
      }
      
      const selectedCategories = [];
      document.querySelectorAll('.category-chip input:checked').forEach(cb => {
        selectedCategories.push(cb.value);
      });
      
      if (selectedCategories.length === 0) {
        return null;
      }
      
      const categoryLabels = {
        consistency: 'Consistency across flows regarding UI',
        ux: 'UX Review',
        ui: 'UI Review',
        accessibility: 'Accessibility Issues',
        design_system: 'Design System Adherence',
        ux_writing: 'Typos & Inconsistent UX Writing',
        high_level: 'High Level Review About and the Why? Questioning the basics.'
      };
      
      const categoryDescriptions = selectedCategories.map(c => categoryLabels[c]).join(', ');
      const prompt = `I am a UI UX designer who lacks attention to detail and makes a lot of mistakes. Act as my manager and reviewer. Provide me feedback on the following areas: ${categoryDescriptions}. For each issue, provide specific actionable suggestions on how to fix it.`;
      
      return { prompt, categories: selectedCategories, isCustom: false };
    }
    
    async function analyze() {
      hideError();
      
      if (!selectionData || !selectionData.hasSelection) {
        showError('Please select a frame or component first');
        return;
      }
      
      const promptData = buildPrompt();
      if (!promptData) {
        showError('Please select at least one category or enter a custom prompt');
        return;
      }
      
      parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
    }
    
    async function runAnalysis(data) {
      const promptData = buildPrompt();
      if (!promptData) return;
      
      showLoading(true);
      appliedItems.clear();
      commentedItems.clear();
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-plugin`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            designData: data.nodes,
            prompt: promptData.prompt,
            categories: promptData.categories,
            isCustom: promptData.isCustom,
            fileName: data.fileName,
            pageName: data.pageName
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Analysis failed (${response.status})`);
        }
        
        const result = await response.json();
        analysisResults = result.feedback || [];
        displayResults();
        
        parent.postMessage({ pluginMessage: { type: 'analysis-complete' } }, '*');
        
      } catch (error) {
        showError(error.message || 'Analysis failed. Please try again.');
        showLoading(false);
        document.getElementById('analysisSection').style.display = 'block';
      }
    }
    
    function displayResults() {
      showLoading(false);
      
      const resultsEl = document.getElementById('results');
      const feedbackList = document.getElementById('feedbackList');
      const summaryStats = document.getElementById('summaryStats');
      const analysisSection = document.getElementById('analysisSection');
      const hideLow = document.getElementById('hideLowSeverity').checked;
      
      analysisSection.style.display = 'none';
      
      // Filter
      let filteredResults = hideLow 
        ? analysisResults.filter(f => f.severity !== 'low')
        : [...analysisResults];
      
      if (filteredResults.length === 0 && analysisResults.length === 0) {
        feedbackList.innerHTML = '<div style="text-align: center; color: #22c55e; padding: 20px;">‚úÖ No issues found! Your design looks great.</div>';
        summaryStats.innerHTML = '';
        resultsEl.classList.add('active');
        return;
      }
      
      // Summary stats
      const highCount = analysisResults.filter(f => f.severity === 'high').length;
      const mediumCount = analysisResults.filter(f => f.severity === 'medium').length;
      const lowCount = analysisResults.filter(f => f.severity === 'low').length;
      
      summaryStats.innerHTML = `
        <div class="stat">
          <div class="stat-value" style="color: #dc2626">${highCount}</div>
          <div class="stat-label">High</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #d97706">${mediumCount}</div>
          <div class="stat-label">Medium</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #16a34a">${lowCount}</div>
          <div class="stat-label">Low</div>
        </div>
        <div class="stat">
          <div class="stat-value">${filteredResults.length}</div>
          <div class="stat-label">Showing</div>
        </div>
      `;
      
      if (currentSort === 'priority') {
        // Sort by severity - normalize severity values first
        const severityOrder = { 'high': 0, 'High': 0, 'HIGH': 0, 'medium': 1, 'Medium': 1, 'MEDIUM': 1, 'low': 2, 'Low': 2, 'LOW': 2 };
        filteredResults.sort((a, b) => {
          const aSev = a.severity ? a.severity.toLowerCase() : 'low';
          const bSev = b.severity ? b.severity.toLowerCase() : 'low';
          const aOrder = aSev === 'high' ? 0 : (aSev === 'medium' ? 1 : 2);
          const bOrder = bSev === 'high' ? 0 : (bSev === 'medium' ? 1 : 2);
          return aOrder - bOrder;
        });
        
        feedbackList.innerHTML = filteredResults.map(item => renderFeedbackItem(item)).join('');
      } else {
        // Group by category
        const grouped = {};
        filteredResults.forEach(item => {
          const cat = item.category || 'general';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(item);
        });
        
        let html = '';
        categoryOrder.forEach(cat => {
          if (grouped[cat] && grouped[cat].length > 0) {
            const config = categoryConfig[cat] || { label: cat, icon: 'üìã' };
            const isCollapsed = collapsedCategories.has(cat);
            html += `
              <div class="category-section">
                <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${cat}')">
                  <span class="category-title">
                    <span>${config.icon}</span>
                    <span>${config.label}</span>
                  </span>
                  <span class="category-count">${grouped[cat].length}</span>
                </div>
                <div class="category-content ${isCollapsed ? 'hidden' : ''}">
                  ${grouped[cat].map(item => renderFeedbackItem(item)).join('')}
                </div>
              </div>
            `;
          }
        });
        
        // Handle unknown categories
        Object.keys(grouped).forEach(cat => {
          if (!categoryOrder.includes(cat)) {
            html += `
              <div class="category-section">
                <div class="category-header" onclick="toggleCategory('${cat}')">
                  <span class="category-title">
                    <span>üìã</span>
                    <span>${cat}</span>
                  </span>
                  <span class="category-count">${grouped[cat].length}</span>
                </div>
                <div class="category-content">
                  ${grouped[cat].map(item => renderFeedbackItem(item)).join('')}
                </div>
              </div>
            `;
          }
        });
        
        feedbackList.innerHTML = html;
      }
      
      resultsEl.classList.add('active');
    }
    
    function renderFeedbackItem(item) {
      const isCommented = commentedItems.has(item.id);
      const isApplied = appliedItems.has(item.id);
      const escapedId = escapeHtml(item.id);
      
      return `
        <div class="feedback-item ${item.severity || 'low'}" onclick="focusNode('${escapedId}')">
          <div class="feedback-title">${escapeHtml(item.title)}</div>
          <div class="feedback-desc">${escapeHtml(item.description)}</div>
          ${item.suggestion ? `<div class="feedback-desc" style="margin-top: 6px; color: #0066cc; font-style: italic;">üí° ${escapeHtml(item.suggestion)}</div>` : ''}
          <div class="feedback-meta">
            <span class="feedback-category">${item.category || 'general'}</span>
            <span class="feedback-severity ${item.severity || 'low'}">${item.severity || 'low'}</span>
            ${item.location ? `<span style="color: #888">üìç ${escapeHtml(item.location)}</span>` : ''}
            ${item.nodeId ? `<span style="color: #0d99ff; font-size: 9px;">üîó Click to focus</span>` : ''}
          </div>
          <div class="feedback-actions" onclick="event.stopPropagation()">
            <button class="btn btn-small ${isCommented ? 'btn-applied' : 'btn-comment'}" 
                    onclick="event.stopPropagation(); postComment('${escapedId}')" ${isCommented ? 'disabled' : ''}>
              ${isCommented ? '‚úì Commented' : 'üí¨ Drop Comment'}
            </button>
            <button class="btn btn-small ${isApplied ? 'btn-applied' : 'btn-apply'}" 
                    onclick="event.stopPropagation(); applySuggestion('${escapedId}')" ${isApplied ? 'disabled' : ''}>
              ${isApplied ? '‚úì Applied' : '‚ú® Apply'}
            </button>
          </div>
        </div>
      `;
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function toggleCategory(cat) {
      if (collapsedCategories.has(cat)) {
        collapsedCategories.delete(cat);
      } else {
        collapsedCategories.add(cat);
      }
      displayResults();
    }
    
    function postComment(itemId) {
      const item = analysisResults.find(f => f.id === itemId);
      if (!item) {
        showToast('Could not find feedback item', 'error');
        return;
      }
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'post-comment',
          itemId: itemId,
          title: item.title,
          description: item.description + (item.suggestion ? '\n\nüí° Suggestion: ' + item.suggestion : ''),
          severity: item.severity,
          location: item.location,
          nodeId: item.nodeId
        } 
      }, '*');
    }
    
    function applySuggestion(itemId) {
      const item = analysisResults.find(f => f.id === itemId);
      if (!item) {
        showToast('Could not find feedback item', 'error');
        return;
      }
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'apply-suggestion',
          itemId: itemId,
          title: item.title,
          description: item.description,
          suggestion: item.suggestion || item.description,
          nodeId: item.nodeId,
          location: item.location
        } 
      }, '*');
    }
    
    function focusNode(itemId) {
      const item = analysisResults.find(f => f.id === itemId);
      if (!item) return;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'focus-node',
          nodeId: item.nodeId,
          location: item.location
        } 
      }, '*');
    }
    
    function resetToAnalysis() {
      document.getElementById('results').classList.remove('active');
      document.getElementById('analysisSection').style.display = 'block';
      analysisResults = [];
      appliedItems.clear();
      commentedItems.clear();
    }
    
    // Event listeners
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('newAnalysisBtn').addEventListener('click', resetToAnalysis);
  </script>
</body>
</html>